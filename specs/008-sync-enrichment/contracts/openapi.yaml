openapi: 3.1.1
info:
  title: Recall.Core.Api | v1 (Sync Enrichment Update)
  description: |
    API contract updates for synchronous enrichment feature (spec 008).
    
    Changes from v1.1.0 (spec 005):
    - POST /api/v1/items now performs synchronous metadata extraction.
      Items are returned with title, excerpt, and previewImageUrl populated in most cases.
    - POST /api/v1/items/{id}/enrich now performs sync enrichment first, async fallback only if needed.
    - New field: `previewImageUrl` on ItemDto (og:image URL stored directly, not downloaded).
    
    The only behavioral changes are:
    1. enrichmentStatus in POST /items response is now often "succeeded" instead of always "pending".
    2. title, excerpt, and previewImageUrl are populated inline when metadata is available.
    3. Async fallback job is published only when preview image URL cannot be obtained synchronously.
  version: 1.2.0
servers:
- url: http://localhost:5080/
paths:
  /api/v1/items:
    post:
      tags:
      - Items
      summary: Save a URL
      description: |
        Save a new URL for later with optional title and tags.
        
        **Synchronous Enrichment Behavior (v1.2.0):**
        - The system fetches the page HTML and extracts metadata (title, excerpt, preview image URL) synchronously.
        - If a preview image URL is found (og:image, twitter:image), it is stored directly on the item as `previewImageUrl` (no image download).
        - If extraction succeeds fully (title + excerpt + previewImageUrl): `enrichmentStatus: "succeeded"`.
        - If title/excerpt found but no og:image: `enrichmentStatus: "pending"`, async screenshot fallback queued.
        - If page is unreachable/times out: `enrichmentStatus: "pending"`, async full-enrichment fallback queued.
        - If URL is SSRF-blocked: `enrichmentStatus: "failed"`, no async fallback.
        - User-provided title is never overwritten by enrichment.
        
        **Deduplication:**
        - If URL already exists, returns existing item (200 OK) without triggering any enrichment.
        
        **Performance:**
        - Sync enrichment is bounded by a strict timeout (≤5s total).
        - The item is always persisted regardless of enrichment outcome.
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateItemRequest'
        required: true
      responses:
        '201':
          description: Created - New item saved (with inline enrichment results)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemDto'
              examples:
                fullyEnriched:
                  summary: Fully enriched (title + excerpt + previewImageUrl)
                  value:
                    id: "507f1f77bcf86cd799439011"
                    url: "https://example.com/article"
                    normalizedUrl: "example.com/article"
                    title: "Example Article Title"
                    excerpt: "A brief description of the article content..."
                    status: "unread"
                    isFavorite: false
                    tags: []
                    createdAt: "2026-02-09T12:00:00Z"
                    updatedAt: "2026-02-09T12:00:00Z"
                    previewImageUrl: "https://example.com/og-image.jpg"
                    thumbnailUrl: null
                    enrichmentStatus: "succeeded"
                    enrichmentError: null
                    enrichedAt: "2026-02-09T12:00:00Z"
                partialEnriched:
                  summary: Partial enrichment (title + excerpt, no og:image — async fallback queued)
                  value:
                    id: "507f1f77bcf86cd799439012"
                    url: "https://example.com/no-og-image"
                    normalizedUrl: "example.com/no-og-image"
                    title: "Page Without Preview Image"
                    excerpt: "This page has metadata but no og:image tag..."
                    status: "unread"
                    isFavorite: false
                    tags: []
                    createdAt: "2026-02-09T12:00:00Z"
                    updatedAt: "2026-02-09T12:00:00Z"
                    previewImageUrl: null
                    thumbnailUrl: null
                    enrichmentStatus: "pending"
                    enrichmentError: null
                    enrichedAt: null
                fetchFailed:
                  summary: Enrichment failed (page unreachable — async fallback queued)
                  value:
                    id: "507f1f77bcf86cd799439013"
                    url: "https://unreachable.example.com"
                    normalizedUrl: "unreachable.example.com"
                    title: null
                    excerpt: null
                    status: "unread"
                    isFavorite: false
                    tags: []
                    createdAt: "2026-02-09T12:00:00Z"
                    updatedAt: "2026-02-09T12:00:00Z"
                    previewImageUrl: null
                    thumbnailUrl: null
                    enrichmentStatus: "pending"
                    enrichmentError: null
                    enrichedAt: null
                ssrfBlocked:
                  summary: SSRF blocked (no async fallback)
                  value:
                    id: "507f1f77bcf86cd799439014"
                    url: "http://192.168.1.1/admin"
                    normalizedUrl: "192.168.1.1/admin"
                    title: null
                    excerpt: null
                    status: "unread"
                    isFavorite: false
                    tags: []
                    createdAt: "2026-02-09T12:00:00Z"
                    updatedAt: "2026-02-09T12:00:00Z"
                    previewImageUrl: null
                    thumbnailUrl: null
                    enrichmentStatus: "failed"
                    enrichmentError: "URL blocked."
                    enrichedAt: null
        '200':
          description: OK - Existing item returned (deduplication — no enrichment triggered)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemDto'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized

    get:
      tags:
      - Items
      summary: List saved items
      description: |
        Retrieve a paginated list of saved items with optional filters.
        Unchanged from v1.1.0. Items now more likely to have enrichment fields populated.
      parameters:
      - name: status
        in: query
        description: Filter by item status (unread, archived)
        schema:
          type: string
      - name: collectionId
        in: query
        description: Filter by collection
        schema:
          type: string
      - name: tag
        in: query
        description: Filter by tag
        schema:
          type: string
      - name: isFavorite
        in: query
        description: Filter by favorite status
        schema:
          type: boolean
      - name: enrichmentStatus
        in: query
        description: Filter by enrichment status
        schema:
          type: string
          enum: [pending, succeeded, failed]
      - name: cursor
        in: query
        description: Pagination cursor
        schema:
          type: string
      - name: limit
        in: query
        description: Page size (default 20, max 50)
        schema:
          type: integer
          format: int32
          default: 20
          maximum: 50
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemListResponse'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized

  /api/v1/items/{id}:
    get:
      tags:
      - Items
      summary: Get item details
      description: |
        Retrieve a single saved item by id.
        Unchanged from v1.1.0.
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemDto'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/items/{id}/thumbnail:
    get:
      tags:
      - Items
      summary: Get item thumbnail
      description: |
        Retrieve the screenshot-based thumbnail image for an item.
        
        This endpoint serves only async-generated screenshots, NOT og:image previews.
        og:image URLs are returned directly in the `previewImageUrl` field of ItemDto
        and can be rendered by the frontend via `<img src="...">` without proxying.
        
        Thumbnails from async screenshot fallback are always JPEG.
      operationId: GetItemThumbnail
      parameters:
      - name: id
        in: path
        required: true
        description: Item ID
        schema:
          type: string
      responses:
        '200':
          description: Thumbnail image
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
        '401':
          description: Unauthorized
        '404':
          description: Item not found or thumbnail not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/items/{id}/enrich:
    post:
      tags:
      - Items
      summary: Trigger item re-enrichment
      description: |
        Manually trigger re-enrichment for an item.
        
        **Behavior (v1.2.0):**
        - Resets `enrichmentStatus` to `pending`
        - Performs synchronous metadata extraction (title, excerpt, og:image URL)
        - If sync enrichment obtains a preview image URL: status set to `succeeded`, no async job
        - If no og:image URL: status remains `pending`, async screenshot fallback queued
        - Returns 202 Accepted with updated enrichment fields
        
        **Use Cases:**
        - Retry after failure
        - Refresh stale metadata
      operationId: EnrichItem
      parameters:
      - name: id
        in: path
        required: true
        description: Item ID
        schema:
          type: string
      responses:
        '202':
          description: Accepted - Re-enrichment performed (may have async fallback queued)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnrichResponse'
        '401':
          description: Unauthorized
        '404':
          description: Item not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    ItemDto:
      type: object
      description: |
        Item data transfer object with enrichment fields.
        New in v1.2.0: `previewImageUrl` field added. Otherwise same fields as v1.1.0.
      properties:
        id:
          type: string
          description: Unique item identifier
          example: "507f1f77bcf86cd799439011"
        url:
          type: string
          description: Original URL
          example: "https://example.com/article"
        normalizedUrl:
          type: string
          description: Normalized URL for deduplication
          example: "example.com/article"
        title:
          type: ['null', string]
          description: |
            Page title. In v1.2.0, this is typically populated inline during item creation
            via sync enrichment. User-provided title takes precedence.
          example: "Example Article Title"
          maxLength: 200
        excerpt:
          type: ['null', string]
          description: |
            Page excerpt/description. In v1.2.0, this is typically populated inline during
            item creation via sync enrichment. User-provided excerpt takes precedence.
          example: "A brief description of the article content..."
          maxLength: 500
        status:
          type: string
          description: Read status
          enum: [unread, archived]
          default: unread
        isFavorite:
          type: boolean
          description: Favorite flag
          default: false
        collectionId:
          type: ['null', string]
          description: Parent collection ID
        tags:
          type: array
          description: Associated tags
          items:
            type: string
        createdAt:
          type: string
          format: date-time
          description: Creation timestamp
        updatedAt:
          type: string
          format: date-time
          description: Last update timestamp
        previewImageUrl:
          type: ['null', string]
          description: |
            External preview image URL extracted from og:image or twitter:image meta tags.
            Set during sync enrichment. The URL is stored directly (no download/proxy).
            The frontend can render this directly via <img src="...">.
            Null if no og:image found (async screenshot fallback may be in progress).
          example: "https://example.com/og-image-1200x630.jpg"
        thumbnailUrl:
          type: ['null', string]
          description: |
            URL to retrieve screenshot-based thumbnail image via the API proxy.
            Format: /api/v1/items/{id}/thumbnail
            Set by the async fallback worker when no og:image was found.
            Null if no screenshot has been captured yet.
            The UI should prefer previewImageUrl over thumbnailUrl when both are available.
          example: "/api/v1/items/507f1f77bcf86cd799439011/thumbnail"
        enrichmentStatus:
          type: string
          description: |
            Current enrichment status.
            In v1.2.0:
            - "succeeded": sync enrichment completed fully (title + excerpt + image)
            - "pending": partial sync enrichment, async fallback queued
            - "failed": SSRF-blocked URL or unrecoverable error
          enum: [pending, succeeded, failed]
          default: pending
        enrichmentError:
          type: ['null', string]
          description: |
            Error message from enrichment. User-safe message only.
          example: "URL blocked."
          maxLength: 500
        enrichedAt:
          type: ['null', string]
          format: date-time
          description: Timestamp of last successful enrichment
      required:
        - id
        - url
        - normalizedUrl
        - status
        - isFavorite
        - tags
        - createdAt
        - updatedAt
        - enrichmentStatus

    ItemListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ItemDto'
        nextCursor:
          type: ['null', string]
          description: Cursor for next page, null if no more results
        hasMore:
          type: boolean
          description: Whether more results exist
      required:
        - items
        - hasMore

    EnrichResponse:
      type: object
      description: |
        Response for re-enrichment trigger.
        In v1.2.0, sync enrichment runs first; status may be "succeeded" or "pending".
      properties:
        message:
          type: string
          description: Status message
          example: "Enrichment completed"
        itemId:
          type: string
          description: Item ID being enriched
        status:
          type: string
          description: Enrichment status after sync processing
          enum: [pending, succeeded, failed]
      required:
        - message
        - itemId
        - status

    CreateItemRequest:
      type: object
      properties:
        url:
          type: string
          description: URL to save
          example: "https://example.com/article"
        title:
          type: ['null', string]
          description: Optional user-provided title (never overwritten by enrichment)
        tags:
          type: ['null', array]
          description: Optional tags to assign
          items:
            type: string
      required:
        - url

    ErrorResponse:
      type: object
      properties:
        error:
          $ref: '#/components/schemas/ErrorDetail'
      required:
        - error

    ErrorDetail:
      type: object
      properties:
        code:
          type: string
          description: Machine-readable error code
          example: "not_found"
        message:
          type: string
          description: Human-readable error message
          example: "Item not found"
      required:
        - code
        - message

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from Entra External ID

security:
  - bearerAuth: []

tags:
- name: Items
  description: Bookmark item operations
